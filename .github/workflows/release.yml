name: release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version"
        required: true
        type: string
      test_release_only:
        description: "åªæµ‹è¯•GitHub Release (ä¸æ‰§è¡Œreleaseæµç¨‹)"
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  id-token: write

jobs:
  release:
    # æµ‹è¯•æ¨¡å¼ä¸‹è·³è¿‡è¿™ä¸ªjob
    if: ${{ github.event.inputs.test_release_only == 'false' }}
    runs-on: ubuntu-latest
    env:
        VERSION: ${{ github.event.inputs.version }}
        BRANCH: releases/${{ github.event.inputs.version }}
    steps:
      - uses: actions/checkout@v3
        with:
          ref: releases/${{ github.event.inputs.version }}
          ssh-key: ${{ secrets.USER_SSH_KEY }}
          fetch-depth: 0
      - name: Set up Python 3.8
        uses: actions/setup-python@v4
        with:
          python-version: "3.8"
      - name: Set up Git
        run: |
          echo "${{ secrets.USER_GPG_KEY }}" | gpg --import
          git config --add user.name "${{ secrets.USER_NAME }}"
          git config --add user.email "${{ secrets.USER_MAIL }}"
          git config --add user.signingkey "${{ secrets.USER_GPG_ID }}"
          git config commit.gpgsign true
      - name: Run build
        run: |
          pip install --upgrade hatch
          hatch version ${{ env.VERSION }}              
          hatch --verbose build
      - name: Merge release branch
        run: |
          git commit -am "Release ${{ env.VERSION }}: increment version"
          git checkout main
          git merge --no-ff ${{ env.BRANCH }}
          git tag -a v${{ env.VERSION }} -m "Release ${{ env.VERSION }}"
          git checkout ${{ env.BRANCH }}
          git merge --ff-only main
          git checkout develop
          git merge --no-ff ${{ env.BRANCH }}
          git push --atomic origin main develop refs/tags/v${{ env.VERSION }} :${{ env.BRANCH }}
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 5
      
      - name: Publish package to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_TOKEN }}
          verbose: true

  # æµ‹è¯•æ¨¡å¼ï¼šåˆ›å»ºmockæ„å»ºäº§ç‰©
  mock-build:
    if: ${{ github.event.inputs.test_release_only == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.8"

      - name: Build or mock artifacts
        run: |
          VERSION="${{ github.event.inputs.version }}"
          
          # æ£€æŸ¥tagæ˜¯å¦å­˜åœ¨
          if ! git tag | grep -q "^v${VERSION}$"; then
            echo "âŒ Tag v${VERSION} ä¸å­˜åœ¨ï¼Œæ— æ³•æµ‹è¯•"
            echo "å¯ç”¨çš„tags:"
            git tag | tail -5
            exit 1
          fi
          
          echo "âœ… ä½¿ç”¨å·²å­˜åœ¨çš„tag: v${VERSION}"
          
          # é€‰é¡¹1: å¦‚æœæƒ³ç”¨çœŸå®æ„å»ºï¼ˆä»å·²æœ‰tagï¼‰
          pip install --upgrade hatch
          git checkout v${VERSION}
          hatch version ${VERSION}
          hatch build
          
          # é€‰é¡¹2: æˆ–è€…ç”¨mockæ–‡ä»¶æµ‹è¯•
          # mkdir -p dist
          # echo "test" > dist/package-${VERSION}.tar.gz
          # echo "test" > dist/package-${VERSION}-py3-none-any.whl
          
          ls -lh dist/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  create-github-release:
    name: Create GitHub Release
    # ç­‰å¾…releaseæˆ–mock-buildå®Œæˆ
    needs: [release, mock-build]
    if: always() && (needs.release.result == 'success' || needs.mock-build.result == 'success')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Generate release notes
        run: |
          VERSION="${{ github.event.inputs.version }}"
          PREV_TAG=$(git describe --tags --abbrev=0 v${VERSION}^ 2>/dev/null || echo "")
          
          # æµ‹è¯•æ¨¡å¼æ ‡è®°
          if [ "${{ github.event.inputs.test_release_only }}" = "true" ]; then
            echo "ğŸ§ª **TEST MODE**" > release_notes.md
            echo "" >> release_notes.md
          fi
          
          echo "## ğŸ“¦ Installation" >> release_notes.md
          echo "" >> release_notes.md
          echo '```bash' >> release_notes.md
          echo "pip install YOUR_PACKAGE_NAME==${VERSION}" >> release_notes.md
          echo '```' >> release_notes.md
          echo "" >> release_notes.md
          
          if [ -n "$PREV_TAG" ]; then
            echo "## ğŸ“ Changes since ${PREV_TAG}" >> release_notes.md
            echo "" >> release_notes.md
            git log ${PREV_TAG}..v${VERSION} --pretty=format:"- %s (%h)" >> release_notes.md
            echo "" >> release_notes.md
          fi
          
          echo "" >> release_notes.md
          echo "## ğŸ” Verification" >> release_notes.md
          echo "" >> release_notes.md
          echo '```bash' >> release_notes.md
          echo "gh attestation verify <file> --owner=YOUR_ORG --repo=YOUR_REPO" >> release_notes.md
          echo '```' >> release_notes.md
          
          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: Release ${{ github.event.inputs.version }}
          body_path: release_notes.md
          files: dist/*
          # æµ‹è¯•æ¨¡å¼åˆ›å»ºdraft
          draft: ${{ github.event.inputs.test_release_only }}
          prerelease: false
          make_latest: ${{ github.event.inputs.test_release_only == 'false' }}

      - name: Generate attestations
        # åªåœ¨æ­£å¼å‘å¸ƒæ—¶ç”Ÿæˆ
        if: ${{ github.event.inputs.test_release_only == 'false' }}
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: 'dist/*'
